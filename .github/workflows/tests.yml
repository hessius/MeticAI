name: Test Suite

on:
  push:
    branches: [ main, develop ]
  pull_request:
    branches: [ main, develop ]

jobs:
  python-tests:
    name: Python Tests (FastAPI)
    runs-on: ubuntu-latest
    permissions:
      contents: read
    
    steps:
      - name: Checkout code
        uses: actions/checkout@v3
      
      - name: Set up Python 3.11
        uses: actions/setup-python@v4
        with:
          python-version: '3.11'
      
      - name: Cache pip packages
        uses: actions/cache@v3
        with:
          path: ~/.cache/pip
          key: ${{ runner.os }}-pip-${{ hashFiles('coffee-relay/requirements-test.txt') }}
          restore-keys: |
            ${{ runner.os }}-pip-
      
      - name: Install dependencies
        run: |
          cd coffee-relay
          pip install --upgrade pip
          pip install -r requirements-test.txt
      
      - name: Run Python tests with coverage
        env:
          GEMINI_API_KEY: test_key_for_ci
        run: |
          cd coffee-relay
          pytest test_main.py test_logging.py -v --cov=main --cov=logging_config --cov-report=xml --cov-report=term-missing
      
      - name: Upload coverage to Codecov
        uses: codecov/codecov-action@v3
        with:
          file: ./coffee-relay/coverage.xml
          flags: python
          name: python-coverage
      
      - name: Check coverage threshold
        run: |
          cd coffee-relay
          coverage report --fail-under=70

  bash-tests:
    name: Bash Tests (Install Scripts)
    runs-on: ubuntu-latest
    permissions:
      contents: read
    
    steps:
      - name: Checkout code
        uses: actions/checkout@v3
      
      - name: Install BATS
        run: |
          sudo apt-get update
          sudo apt-get install -y bats
      
      - name: Make install scripts executable
        run: |
          chmod +x local-install.sh
          chmod +x web_install.sh
          chmod +x uninstall.sh
      
      - name: Run Bash tests
        run: |
          bats tests/test_local_install.bats
          bats tests/test_web_install.bats
          bats tests/test_uninstall.bats
      
      - name: Verify script syntax
        run: |
          bash -n local-install.sh
          bash -n web_install.sh
          bash -n uninstall.sh

  integration-check:
    name: Integration Tests
    runs-on: ubuntu-latest
    needs: [python-tests, bash-tests]
    permissions:
      contents: read
    
    steps:
      - name: Checkout code
        uses: actions/checkout@v3
      
      - name: Verify Dockerfiles syntax
        run: |
          docker build --no-cache -f coffee-relay/Dockerfile -t test-coffee-relay coffee-relay || exit 1
          docker build --no-cache -f gemini-client/Dockerfile -t test-gemini-client gemini-client || exit 1
      
      - name: Test docker-compose syntax
        run: |
          docker compose config

  lint-check:
    name: Code Quality Checks
    runs-on: ubuntu-latest
    permissions:
      contents: read
    
    steps:
      - name: Checkout code
        uses: actions/checkout@v3
      
      - name: Set up Python 3.11
        uses: actions/setup-python@v4
        with:
          python-version: '3.11'
      
      - name: Install linting tools
        run: |
          pip install flake8 black
      
      - name: Run flake8
        run: |
          flake8 coffee-relay/main.py coffee-relay/logging_config.py --max-line-length=100 --ignore=E501,W503
        continue-on-error: true
      
      - name: Check code formatting with black
        run: |
          black --check coffee-relay/main.py coffee-relay/logging_config.py
        continue-on-error: true
      
      - name: Lint shell scripts
        run: |
          sudo apt-get install -y shellcheck
          shellcheck local-install.sh || true
          shellcheck web_install.sh || true
