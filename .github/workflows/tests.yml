name: Test Suite

on:
  push:
    branches: [main, develop, version/2.0.0]
  pull_request:
    branches: [main, develop, version/2.0.0]

jobs:
  # ============================================================================
  # Relay Server Tests (Python/FastAPI)
  # ============================================================================
  server-tests:
    name: Server Tests (Python)
    runs-on: ubuntu-latest
    defaults:
      run:
        working-directory: apps/server
    permissions:
      contents: read

    steps:
      - name: Checkout code
        uses: actions/checkout@v4
        with:
          submodules: recursive

      - name: Set up Python 3.12
        uses: actions/setup-python@v5
        with:
          python-version: "3.12"
          cache: "pip"
          cache-dependency-path: apps/server/requirements-test.txt

      - name: Install dependencies
        run: |
          pip install --upgrade pip
          pip install -r requirements-test.txt

      - name: Run Python tests with coverage
        env:
          GEMINI_API_KEY: test_key_for_ci
        run: |
          pytest test_main.py test_logging.py -v \
            --cov=main --cov=logging_config --cov=config \
            --cov=prompt_builder --cov=api --cov=services \
            --cov=utils --cov=models \
            --cov-report=xml --cov-report=term-missing

      - name: Upload coverage to Codecov
        uses: codecov/codecov-action@v4
        with:
          file: ./apps/server/coverage.xml
          flags: relay
          name: server-coverage

      - name: Check coverage threshold
        run: coverage report --fail-under=68

  # ============================================================================
  # Web Frontend Tests (TypeScript/React)
  # ============================================================================
  web-tests:
    name: Web Tests (TypeScript)
    runs-on: ubuntu-latest
    defaults:
      run:
        working-directory: apps/web
    permissions:
      contents: read

    steps:
      - name: Checkout code
        uses: actions/checkout@v4
        with:
          submodules: recursive

      - name: Setup Bun
        uses: oven-sh/setup-bun@v2
        with:
          bun-version: latest

      - name: Install dependencies
        run: bun install --frozen-lockfile

      - name: Run linter
        run: bun run lint

      - name: Run unit tests
        run: bun run test:run

      - name: Generate coverage report
        run: bun run test:coverage

      - name: Upload coverage to Codecov
        uses: codecov/codecov-action@v4
        with:
          files: ./apps/web/coverage/coverage-final.json
          flags: web
          name: web-coverage

  # ============================================================================
  # Web E2E Tests (Playwright)
  # ============================================================================
  web-e2e-tests:
    name: Web E2E Tests
    runs-on: ubuntu-latest
    needs: [web-tests]
    defaults:
      run:
        working-directory: apps/web
    permissions:
      contents: read

    steps:
      - name: Checkout code
        uses: actions/checkout@v4
        with:
          submodules: recursive

      - name: Setup Bun
        uses: oven-sh/setup-bun@v2
        with:
          bun-version: latest

      - name: Install dependencies
        run: bun install --frozen-lockfile

      - name: Install Playwright Browsers
        run: bunx playwright install --with-deps

      - name: Run E2E tests
        run: bun run e2e

      - name: Upload Playwright Report
        uses: actions/upload-artifact@v4
        if: always()
        with:
          name: playwright-report
          path: apps/web/playwright-report/
          retention-days: 30

  # ============================================================================
  # MCP Server Tests (Python)
  # ============================================================================
  mcp-server-tests:
    name: MCP Server Tests
    runs-on: ubuntu-latest
    defaults:
      run:
        working-directory: apps/mcp-server
    permissions:
      contents: read
      checks: write
      pull-requests: write

    steps:
      - name: Checkout code
        uses: actions/checkout@v4
        with:
          submodules: recursive

      - name: Set up Python 3.11
        uses: actions/setup-python@v5
        with:
          python-version: "3.11"
          cache: "pip"
          cache-dependency-path: apps/mcp-server/meticulous-mcp/requirements.txt

      - name: Install dependencies
        run: |
          cd meticulous-mcp
          pip install --upgrade pip
          pip install -r requirements.txt

      - name: Run tests
        run: |
          cd meticulous-mcp
          PYTHONPATH=${{ github.workspace }}/apps/mcp-server/meticulous-mcp/src \
          python -m pytest tests/ -v --tb=short --junitxml=test-results.xml

      - name: Upload test results
        if: always()
        uses: actions/upload-artifact@v4
        with:
          name: mcp-test-results
          path: apps/mcp-server/meticulous-mcp/test-results.xml

  # ============================================================================
  # Docker Build Tests
  # ============================================================================
  docker-build:
    name: Docker Build Test
    runs-on: ubuntu-latest
    needs: [server-tests, web-tests]
    permissions:
      contents: read

    steps:
      - name: Checkout code
        uses: actions/checkout@v4
        with:
          submodules: recursive

      - name: Set up Docker Buildx
        uses: docker/setup-buildx-action@v3

      - name: Build unified image
        uses: docker/build-push-action@v5
        with:
          context: .
          file: docker/Dockerfile.unified
          push: false
          load: true
          tags: meticai:test
          cache-from: type=gha
          cache-to: type=gha,mode=max

      - name: Test container starts
        run: |
          docker run -d --name test-container \
            -e GEMINI_API_KEY=test \
            -e METICULOUS_IP=127.0.0.1 \
            meticai:test

          # Wait for container to start
          sleep 15

          # Check container is running
          docker ps | grep test-container

          # Check health endpoint
          docker exec test-container curl -f http://localhost:3550/health || exit 1

      - name: Cleanup
        if: always()
        run: |
          docker stop test-container || true
          docker rm test-container || true

  # ============================================================================
  # Code Quality
  # ============================================================================
  lint:
    name: Code Quality
    runs-on: ubuntu-latest
    permissions:
      contents: read

    steps:
      - name: Checkout code
        uses: actions/checkout@v4
        with:
          submodules: recursive

      - name: Set up Python 3.12
        uses: actions/setup-python@v5
        with:
          python-version: "3.12"

      - name: Install Python linting tools
        run: pip install ruff black

      - name: Run ruff on relay
        run: ruff check apps/server/
        continue-on-error: true

      - name: Check Python formatting
        run: black --check apps/server/
        continue-on-error: true

      - name: Setup Bun
        uses: oven-sh/setup-bun@v2
        with:
          bun-version: latest

      - name: Install web dependencies
        run: |
          cd apps/web
          bun install --frozen-lockfile

      - name: Lint web
        run: |
          cd apps/web
          bun run lint
        continue-on-error: true

      - name: Lint shell scripts
        run: |
          sudo apt-get install -y shellcheck
          shellcheck scripts/*.sh || true

  # ============================================================================
  # Windows Installer Tests (PowerShell/Pester)
  # ============================================================================
  windows-installer-tests:
    name: Windows Installer Tests (Pester)
    runs-on: ubuntu-latest
    permissions:
      contents: read

    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Install Pester
        shell: pwsh
        run: |
          Install-Module -Name Pester -MinimumVersion 5.0 -Force -Scope CurrentUser

      - name: Run Pester tests
        shell: pwsh
        run: |
          $config = New-PesterConfiguration
          $config.Run.Path = "./scripts/install.Tests.ps1"
          $config.Run.Exit = $true
          $config.Output.Verbosity = "Detailed"
          $config.TestResult.Enabled = $true
          $config.TestResult.OutputPath = "pester-results.xml"
          $config.TestResult.OutputFormat = "JUnitXml"
          Invoke-Pester -Configuration $config

      - name: Upload test results
        if: always()
        uses: actions/upload-artifact@v4
        with:
          name: pester-test-results
          path: pester-results.xml
          retention-days: 30
